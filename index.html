<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KISMET 登録・ログインフロー モックアップ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interフォントを優先し、フォールバックを設定 */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8fafc; /* 背景色 */
        }
        /* KISMETブランドカラー */
        .kismet-primary-red {
            color: #d8337a; /* メインのピンク色 */
        }
        .kismet-primary-bg {
            background-color: #d8337a; /* メインのピンク色 */
        }
        /* ステップ完了時の配色 */
        .kismet-complete-green {
             background-color: #4dc772; /* 完了の緑色 */
        }
        .kismet-complete-text {
             color: #4dc772; /* 完了の緑色テキスト */
        }
        
        /* その他の装飾用クラス */
        .kismet-soft-pink { background-color: #fcf1f5; }
        .kismet-soft-blue { background-color: #eff3fe; color: #4b6bfb; }
        .kismet-soft-green { background-color: #effcf1; color: #4dc772; }

        /* 画面を中央に固定するためのスタイル */
        #app-container {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        /* 画面コンテナの幅とアニメーション */
        .screen-container {
            width: 100%;
            max-width: 420px;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease-out;
            transform: scale(1);
            opacity: 1;
        }
        
        .screen-container.hide {
            opacity: 0;
            transform: scale(0.95);
        }

        /* 6桁入力フィールドのカスタムスタイル */
        .password-input-group input {
            text-align: center;
            font-size: 1.5rem;
            /* 5つのステップに合わせた均等な幅を確保 */
            width: 15%; 
            padding: 0.5rem 0;
        }
    </style>
</head>
<body>

    <!-- メインコンテナ -->
    <div id="app-container">
        <div id="app" class="screen-container">
            <!-- 画面コンテンツはJavaScriptで動的に切り替えます -->
        </div>
    </div>

    <!-- カスタムモーダル（alert()の代替） -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 items-center justify-center z-50 transition-opacity duration-300">
        <div id="modal-content" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center transform scale-90 opacity-0 transition-all duration-300">
            <!-- Modal message will be inserted here -->
        </div>
    </div>


    <script>
        // 状態管理
        let currentPage = 'home';
        // ステップは5つ: 1:電話, 2:プロフィール, 3:メール, 4:年齢確認, 5:パスワード
        let registrationStep = 1; 
        let isAccountActive = false; // 審査が通ってログイン可能かどうか
        
        // ユーザーデータとログイン情報のモック
        let userData = {
            userId: 'KISMET_10001', // 審査完了後に通知されるID
            phoneNumber: '09012345678',
            authCode: '123456',
            name: 'アカリ',
            gender: '女性',
            age: 26,
            comment: 'こんにちは！素敵な出会いを探しています。', 
            email: 'kismet@example.com', 
            isAgeVerified: false, // 年齢確認書類提出済み
            password: '123456', // モックのパスワード
            tempLoginId: '', // ログイン画面で一時的に保持するID
            tempLoginPw: '' // ログイン画面で一時的に保持するPW
        };

        const appElement = document.getElementById('app');

        // -----------------------
        // 画面定義 (HTMLテンプレート)
        // -----------------------
        
        // ヘッダーテンプレート (ロゴとキャッチフレーズ)
        const getHeader = (title = null) => `
            <div class="text-center pt-8 pb-4">
                <div class="kismet-primary-red text-2xl font-bold tracking-wider mb-1">
                    <span class="mr-1">&hearts;</span> KISMET
                </div>
                ${title ? 
                    `<h2 class="text-2xl font-bold mt-4">${title}</h2>` : 
                    `<p class="text-sm text-gray-500">運命を、期限付きで。</p>`}
            </div>
        `;

        // 登録ステップインジケーター (5ステップ復元、区切り線なし、配色を修正)
        const getStepIndicator = (currentStep) => {
            // 元の5ステップに戻しました
            const steps = [
                { id: 1, label: '電話番号' },
                { id: 2, label: 'プロフィール' },
                { id: 3, label: 'メールアドレス' }, 
                { id: 4, label: '年齢確認' },
                { id: 5, label: 'パスワード設定' } 
            ];
            
            return `
                <div class="flex justify-between items-start text-center px-4 py-4 mb-4 relative">
                    <!-- ステップの円とラベル -->
                    ${steps.map((step, index) => {
                        let circleClass = 'bg-gray-300';
                        let labelClass = 'text-gray-500';

                        if (step.id === currentStep) {
                            // 現在のステップはKISMETのピンク（円とテキスト）
                            circleClass = 'kismet-primary-bg shadow-lg shadow-pink-300/50';
                            labelClass = 'kismet-primary-red font-semibold';
                        } else if (step.id < currentStep) {
                            // 完了したステップは緑（円とテキスト）
                            circleClass = 'kismet-complete-green shadow-lg shadow-green-300/50'; 
                            labelClass = 'kismet-complete-text font-semibold';
                        }
                        
                        return `
                            <div class="flex flex-col items-center z-10 mx-1 flex-1">
                                <div class="w-7 h-7 rounded-full flex items-center justify-center text-white font-bold text-xs transition-colors duration-300 ${circleClass} flex-shrink-0 mb-1">
                                    ${step.id}
                                </div>
                                <div class="text-[0.6rem] leading-tight transition-colors duration-300 ${labelClass} w-full px-0 overflow-hidden text-clip whitespace-nowrap">
                                    ${step.label}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // --- 1. トップ画面 (HOME) ---
        const homeTemplate = `
            ${getHeader()}
            <div class="p-8 pt-0">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 leading-tight mb-6">
                    本当にメッセージが続く<br>マッチングだけを。
                </h1>
                <p class="text-sm text-gray-600 mb-8">
                    いいねが成立したら、女性からのアクション期限は**たった24時間**。ダラダラとした関係はもう終わり。運命の出会いを逃さない仕組みです。
                </p>

                <div class="space-y-4 mb-10">
                    <div class="p-4 rounded-xl kismet-soft-pink border-2 border-pink-100 flex items-start">
                        <div class="text-xl kismet-primary-red mr-3 mt-1">&#128337;</div>
                        <div>
                            <h3 class="font-bold text-gray-900">【24時間の期限】</h3>
                            <p class="text-xs text-gray-600">マッチングリストが溜まる心配なし。本当に興味のある相手とだけ、集中してコミュニケーションが始まります。</p>
                        </div>
                    </div>
                    <div class="p-4 rounded-xl kismet-soft-blue border-2 border-blue-100 flex items-start">
                        <div class="text-xl text-blue-600 mr-3 mt-1">⚡️</div>
                        <div>
                            <h3 class="font-bold text-gray-900">【女性がファーストステップ】</h3>
                            <p class="text-xs text-gray-600">女性からのメッセージでチャットがオープン。男性は待つだけ、女性は「いいね」と思った相手にだけ迷わずアプローチできます。</p>
                        </div>
                    </div>
                    <div class="p-4 rounded-xl kismet-soft-green border-2 border-green-100 flex items-start">
                        <div class="text-xl text-green-600 mr-3 mt-1">&#10003;</div>
                        <div>
                            <h3 class="font-bold text-gray-900">【真剣な出会いの場】</h3>
                            <p class="text-xs text-gray-600">期限とルールの存在が、お互いに「今すぐ動く」モチベーションとなり、真剣な関係構築を後押しします。</p>
                        </div>
                    </div>
                </div>
                
                <button onclick="checkRegistrationStatus()" class="w-full py-3 kismet-primary-bg text-white font-bold rounded-xl shadow-lg hover:opacity-90 transition duration-150">
                    KISMETを始める（無料登録へ）
                </button>
                
                <div class="text-center mt-4">
                    <button onclick="navigate('login')" class="text-sm text-gray-600 hover:text-gray-900 transition duration-150">
                        すでにアカウントをお持ちの方はこちら (ログイン画面へ)
                    </button>
                </div>

                <div class="text-center text-xs text-gray-400 mt-8">
                    &copy; 2025 KISMET Fate Matching Service.
                </div>
            </div>
        `;

        // ログイン成功後の本アプリ画面 (新規追加)
        const mainAppTemplate = `
            ${getHeader('KISMETへようこそ！')}
            <div class="p-8 pt-0">
                <div class="p-6 rounded-xl bg-green-50 border border-green-300 text-green-800 mb-6">
                    <p class="font-bold text-lg">✅ 認証済みアカウント</p>
                    <p class="text-sm mt-2">全ての機能をご利用いただけます。早速、運命の相手を探しに行きましょう！</p>
                    <p class="text-xs mt-3 text-gray-500">ユーザーID: ${userData.userId}</p>
                </div>
                
                <button onclick="alertMessage('スワイプ画面へ遷移します！')" class="w-full py-4 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition duration-150">
                    KISMETを始める
                </button>

                <button onclick="logout()" class="w-full py-2 text-sm text-red-500 hover:text-red-700 transition duration-150 mt-4">
                    ログアウト
                </button>

                <div class="text-center text-xs text-gray-400 mt-8">
                    &copy; 2025 KISMET Fate Matching Service.
                </div>
            </div>
        `;

        // 審査待機中の画面 (新規追加)
        const reviewPendingTemplate = `
            ${getHeader('アカウント審査中')}
            <div class="p-8 pt-0">
                <div class="p-6 rounded-xl bg-yellow-50 border border-yellow-300 text-yellow-800 mb-6">
                    <p class="font-bold text-lg">⏳ 年齢確認審査中です</p>
                    <p class="text-sm mt-2">ご提出ありがとうございます。審査結果は**メール**で通知します。通知が届くまで、しばらくお待ちください。</p>
                    <p class="text-xs mt-3 text-gray-500">※審査完了後、改めてメールからログインをお願いします。</p>
                </div>

                <button disabled class="w-full py-3 bg-gray-400 text-white font-bold rounded-xl shadow-lg cursor-not-allowed">
                    審査完了までお待ちください
                </button>
                
                <button onclick="navigate('home')" class="mt-6 w-full py-2 text-sm text-gray-500 hover:text-pink-600 transition duration-150">
                    トップに戻る
                </button>

                <div class="text-center text-xs text-gray-400 mt-8">
                    &copy; 2025 KISMET Fate Matching Service.
                </div>
            </div>
        `;
        
        // --- 2. 登録画面 (REGISTER) ---
        const registerTemplate = `
            ${getHeader('新規アカウント作成')}
            <div class="p-8 pt-0">
                ${getStepIndicator(registrationStep)}
                
                <div id="registration-content">
                    <!-- ステップごとのコンテンツをJSで挿入 -->
                </div>
                
                <button onclick="navigate('home')" class="mt-6 w-full py-2 text-sm text-gray-500 hover:text-pink-600 transition duration-150">
                    トップに戻る
                </button>
            </div>
        `;
        
        // ステップ1: 電話番号認証
        const step1Template = `
            <h3 class="text-xl font-bold text-gray-900 mb-4">ステップ1: 電話番号の確認</h3>
            <p class="text-sm text-gray-600 mb-6">不正利用防止のため、SMSによる本人確認を行います。（この成功でアカウントが確定します）</p>

            <div id="phone-input-section">
                <input type="tel" id="phone-number" placeholder="09012345678" value="${userData.phoneNumber}"
                       class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-pink-500 transition duration-150 shadow-inner mb-6"
                       oninput="userData.phoneNumber = this.value.replace(/[^0-9]/g, '');">
                
                <button onclick="sendAuthCode()" id="send-code-btn" 
                        class="w-full py-4 kismet-primary-bg text-white font-bold rounded-xl shadow-md hover:opacity-90 transition duration-150">
                    認証コードを送信
                </button>
            </div>
            
            <div id="code-input-section" class="hidden">
                <p class="text-sm text-green-600 mb-4">
                    ${userData.phoneNumber}に認証コードを送信しました。
                </p>
                <input type="number" id="auth-code" placeholder="123456" value="${userData.authCode}"
                       class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-pink-500 transition duration-150 shadow-inner mb-6"
                       oninput="userData.authCode = this.value.replace(/[^0-9]/g, '');">
                
                <button onclick="verifyCode()" id="verify-code-btn" 
                        class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 transition duration-150">
                    コードを検証して次へ
                </button>
            </div>
        `;

        // ステップ2: プロフィール登録
        const step2Template = `
            <h3 class="text-xl font-bold text-gray-900 mb-4">ステップ2: プロフィール登録</h3>
            <p class="text-sm text-gray-600 mb-6">スワイプするための基本情報を入力してください。</p>
            
            <div class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">名前</label>
                    <input type="text" id="name" placeholder="アカリ" value="${userData.name}"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 shadow-sm"
                           oninput="userData.name = this.value">
                </div>
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">性別</label>
                        <select id="gender" class="w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 shadow-sm bg-white"
                                onchange="userData.gender = this.value">
                            <option value="女性" ${userData.gender === '女性' ? 'selected' : ''}>女性 (Female)</option>
                            <option value="男性" ${userData.gender === '男性' ? 'selected' : ''}>男性 (Male)</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="age" class="block text-sm font-medium text-gray-700 mb-1">年齢</label>
                        <input type="number" id="age" placeholder="26" value="${userData.age}"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 shadow-sm"
                               oninput="userData.age = this.value">
                    </div>
                </div>

                <div>
                    <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">自己紹介コメント (任意)</label>
                    <textarea id="comment" placeholder="KISMETで素敵な出会いを探しています！"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 shadow-sm h-24 resize-none"
                              oninput="userData.comment = this.value">${userData.comment}</textarea>
                </div>

                <div class="pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">プロフィール写真のアップロード</label>
                    <div class="w-full border-2 border-dashed border-gray-300 p-8 rounded-xl text-center text-gray-500">
                        <div class="text-3xl mb-2">⬆️</div>
                        <p class="text-sm">写真を追加（必須）</p>
                    </div>
                </div>

                <button onclick="nextStep()" id="profile-submit-btn" 
                        class="w-full py-4 kismet-primary-bg text-white font-bold rounded-xl shadow-md hover:opacity-90 transition duration-150 mt-6">
                    プロフィールを登録して次へ
                </button>
            </div>
        `;

        // ステップ3: メールアドレス入力
        const step3Template = `
            <h3 class="text-xl font-bold text-gray-900 mb-4">ステップ3: メールアドレスの登録</h3>
            <p class="text-sm text-gray-600 mb-6">
                審査結果、重要なお知らせ、およびパスワード再設定の通知は、このメールアドレスに届きます。
            </p>

            <div class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">メールアドレス</label>
                    <input type="email" id="email" placeholder="kismet@example.com" value="${userData.email}"
                           class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-pink-500 transition duration-150 shadow-inner"
                           oninput="userData.email = this.value">
                </div>
                
                <p class="text-xs text-gray-500">
                    @docomo.ne.jpや@softbank.ne.jpなどのキャリアメールは、迷惑メール設定により届かない場合があります。
                </p>

                <button onclick="validateEmailAndNext()" 
                        class="w-full py-4 kismet-primary-bg text-white font-bold rounded-xl shadow-md hover:opacity-90 transition duration-150 mt-4">
                    メールアドレスを登録して次へ
                </button>
            </div>
        `;

        // ステップ4: 年齢確認
        const step4Template = `
            <h3 class="text-xl font-bold kismet-primary-red mb-4">⚠️ サービス利用前の重要ステップ</h3>
            <h4 class="text-xl font-bold text-gray-900 mb-6">公的書類による年齢確認</h4>

            <div class="p-4 rounded-lg bg-red-50 border border-red-300 mb-6">
                <p class="text-sm font-semibold text-red-600 mb-2">【法律で必須】</p>
                <p class="text-xs text-red-700">日本の法律に基づき、**18歳未満の方の利用を防ぐ**ため、全てのユーザーに年齢確認書類の提出を義務付けています。</p>
            </div>

            <h4 class="font-bold text-gray-900 mb-3">提出できる書類の例:</h4>
            <ul class="list-disc list-inside space-y-1 text-sm text-gray-600 mb-8 ml-4">
                <li>運転免許証</li>
                <li>健康保険証</li>
                <li>パスポート</li>
                <li>マイナンバーカード</li>
            </ul>
            
            <p class="text-xs text-gray-500 mb-8">
                書類提出後、運営による確認が完了するまでサービスは利用できません。
            </p>

            <button onclick="nextStep()" 
                    class="w-full py-4 bg-red-600 text-white font-bold rounded-xl shadow-md hover:bg-red-700 transition duration-150">
                書類を提出する（モック：次のステップへ）
            </button>
        `;

        // ステップ5: パスワード設定
        const step5Template = `
            <h3 class="text-xl font-bold text-gray-900 mb-4">ステップ5: パスワード設定</h3>
            <p class="text-sm text-gray-600 mb-6">
                ログイン時に使用する**6桁のパスワード（半角数字のみ）**を設定してください。
            </p>

            <div class="space-y-6">
                <div class="flex justify-center password-input-group space-x-2">
                    <!-- 6つの入力フィールドを生成 -->
                    ${Array.from({ length: 6 }).map((_, i) => `
                        <input type="tel" maxlength="1" id="pw-digit-${i}" 
                               class="border-2 border-gray-300 rounded-lg focus:border-pink-500 shadow-inner"
                               oninput="handlePasswordInput(this, ${i})"
                               pattern="[0-9]" inputmode="numeric">
                    `).join('')}
                </div>
                
                <p id="password-error" class="text-sm text-red-500 text-center hidden">
                    パスワードは6桁の数字である必要があります。
                </p>

                <button onclick="completeRegistration()" id="pw-submit-btn" disabled 
                        class="w-full py-4 bg-gray-400 text-white font-bold rounded-xl shadow-md transition duration-150 mt-4">
                    このパスワードで登録を完了する
                </button>
            </div>
        `;
        
        // --- 3. ログイン画面 (LOGIN) ---
        const loginTemplate = `
            ${getHeader('アカウントにログイン')}
            <div class="p-8 pt-0">
                <h3 class="text-xl font-bold text-gray-900 mb-4">ユーザーIDとパスワードでログイン</h3>
                <p class="text-sm text-gray-600 mb-6">
                    審査完了メールに記載のユーザーIDと、登録時に設定した6桁のパスワードを入力してください。（モックではID: ${userData.userId}、PW: ${userData.password}）
                </p>

                <div class="space-y-4">
                    <div>
                        <label for="login-id" class="block text-sm font-medium text-gray-700 mb-1">ユーザーID</label>
                        <input type="text" id="login-id" placeholder="KISMET_10001" value="${userData.tempLoginId}"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 shadow-sm"
                               oninput="userData.tempLoginId = this.value">
                    </div>
                    <div>
                        <label for="login-pw" class="block text-sm font-medium text-gray-700 mb-1">パスワード（6桁）</label>
                        <input type="password" id="login-pw" placeholder="••••••" value="${userData.tempLoginPw}" maxlength="6"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:border-pink-500 shadow-sm"
                               oninput="userData.tempLoginPw = this.value">
                    </div>
                </div>

                <button onclick="handleLogin()" 
                        class="w-full py-4 kismet-primary-bg text-white font-bold rounded-xl shadow-md hover:opacity-90 transition duration-150 mt-8">
                    ログイン
                </button>
                
                <div class="text-center mt-6">
                    <button onclick="navigate('home')" class="text-sm text-gray-500 hover:text-pink-600 transition duration-150">
                        トップに戻る
                    </button>
                </div>
            </div>
        `;

        // -----------------------
        // ロジック関数
        // -----------------------
        
        // トップ画面から「KISMETを始める」を押したときのステータスチェック
        window.checkRegistrationStatus = function() {
            if (isAccountActive) {
                // 既にログイン済み（アカウント有効）
                navigate('mainApp');
            } else if (userData.isAgeVerified) {
                // 書類提出済みだが、まだアクティブでない（審査中）
                navigate('reviewPending');
            } else {
                // 新規登録開始
                // ステップインジケーターに合わせて、ステップ数を1に戻す
                registrationStep = 1; 
                navigate('register');
            }
        }

        // パスワード入力処理（フォーカス移動と結合）
        window.handlePasswordInput = function(input, index) {
            // 数字以外を削除
            input.value = input.value.replace(/[^0-9]/g, '').slice(0, 1);
            
            // 次のフィールドにフォーカスを移動
            if (input.value.length === 1 && index < 5) {
                const nextInput = document.getElementById(`pw-digit-${index + 1}`);
                if (nextInput) nextInput.focus();
            }

            // 全て入力されたかチェック
            checkPasswordCompletion();
        }

        // パスワード入力完了チェック
        function checkPasswordCompletion() {
            let password = '';
            for (let i = 0; i < 6; i++) {
                const input = document.getElementById(`pw-digit-${i}`);
                // input が null の場合があるためチェック
                if (!input || input.value.length !== 1) { 
                    const btn = document.getElementById('pw-submit-btn');
                    if (btn) {
                        btn.disabled = true;
                        btn.classList.remove('kismet-primary-bg', 'hover:opacity-90');
                        btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    }
                    return false;
                }
                password += input.value;
            }
            // userData.password = password; // モックのため固定値のままにしておく
            const btn = document.getElementById('pw-submit-btn');
            if (btn) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('kismet-primary-bg', 'hover:opacity-90');
            }
            return true;
        }


        // 画面切り替えとアニメーション
        function navigate(page) {
            const currentElement = appElement;
            currentElement.classList.add('hide');
            
            setTimeout(() => {
                currentPage = page;
                if (page === 'register') {
                    // 登録フロー開始時にステップをリセット
                    if (registrationStep > 1) { 
                       registrationStep = 1;
                    }
                }
                
                render();
                currentElement.classList.remove('hide');
            }, 300);
        }

        // ステップ遷移
        window.nextStep = function() {
            if (registrationStep < 5) { // ステップは1から5まで
                registrationStep++;
                render();
            }
        }
        
        // ステップ1: 認証コード送信
        window.sendAuthCode = function() {
            if (userData.phoneNumber.length < 10) {
                alertMessage('有効な電話番号を入力してください。');
                return;
            }
            
            document.getElementById('phone-input-section').classList.add('hidden');
            document.getElementById('code-input-section').classList.remove('hidden');
        }

        // ステップ1: コード検証
        window.verifyCode = function() {
            if (userData.authCode === '123456') { // モック用の固定コード
                nextStep(); // ステップ2へ。ここで registrationStep が 2 になり、render() が呼ばれる。
            } else {
                alertMessage('認証コードが正しくありません。');
            }
        }

        // ステップ3: メールアドレス検証
        window.validateEmailAndNext = function() {
            const emailInput = document.getElementById('email');
            const emailValue = emailInput.value.trim();

            if (!emailValue.includes('@') || !emailValue.includes('.')) {
                alertMessage('有効なメールアドレスを入力してください。');
                return;
            }
            userData.email = emailValue;
            nextStep(); // ステップ4へ
        }

        // ステップ5: パスワード設定完了 (登録完了)
        window.completeRegistration = function() {
            if (checkPasswordCompletion()) {
                // パスワード設定完了
                const currentPassword = Array.from({ length: 6 }).map((_, i) => document.getElementById(`pw-digit-${i}`).value).join('');
                userData.password = currentPassword; // 設定されたパスワードを保持

                userData.isAgeVerified = true; // 年齢確認書類提出済みフラグを立てる
                
                alertMessage(`ご登録ありがとうございます。書類確認のため、審査待機画面に戻ります。審査結果はメールにてお知らせします。`);

                navigate('reviewPending'); // 審査待機中のホーム画面へ
            }
        }
        
        // ログイン処理
        window.handleLogin = function() {
            const id = userData.tempLoginId || document.getElementById('login-id')?.value;
            const pw = userData.tempLoginPw || document.getElementById('login-pw')?.value;
            
            // ログイン成功の条件: IDが一致 AND パスワードが一致 AND アカウントが有効化されている
            if (id === userData.userId && pw === userData.password && userData.isAgeVerified) {
                isAccountActive = true;
                userData.tempLoginId = ''; 
                userData.tempLoginPw = '';
                alertMessage('ログインに成功しました。KISMETへようこそ！');
                navigate('mainApp'); // 本サービス利用可能状態の画面へ
            } else if (id === userData.userId && userData.isAgeVerified === true && pw !== userData.password) {
                alertMessage('パスワードが正しくありません。');
            }
            else {
                alertMessage('ユーザーIDまたはパスワードが正しくありません。アカウントがまだ有効でない可能性もあります。審査完了メールをご確認ください。');
            }
        }

        // ログアウト処理
        window.logout = function() {
            isAccountActive = false;
            alertMessage('ログアウトしました。');
            navigate('home');
        }


        // カスタムアラート（alert()の代替）
        window.alertMessage = function(message) {
            const modalElement = document.getElementById('custom-modal');
            const modalContent = document.getElementById('modal-content');

            modalContent.innerHTML = `
                <p class="text-lg font-medium text-gray-800 mb-4">${message}</p>
                <button id="modal-ok-btn" 
                        class="px-4 py-2 kismet-primary-bg text-white rounded-lg hover:opacity-90 transition duration-150">
                    OK
                </button>
            `;
            modalElement.classList.remove('hidden');
            modalElement.classList.add('flex', 'opacity-100');
            modalContent.classList.remove('scale-90', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
            
            document.getElementById('modal-ok-btn').onclick = () => {
                modalElement.classList.remove('flex', 'opacity-100');
                modalElement.classList.add('hidden', 'opacity-0');
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-90', 'opacity-0');
            };
        }

        // 描画関数
        function render() {
            let content = '';
            
            switch (currentPage) {
                case 'home':
                    content = homeTemplate;
                    break;
                case 'mainApp':
                    content = mainAppTemplate;
                    break;
                case 'reviewPending':
                    content = reviewPendingTemplate;
                    break;
                case 'register':
                    content = registerTemplate;
                    // registration-contentの中にステップごとの内容を挿入
                    setTimeout(() => {
                        const regContent = document.getElementById('registration-content');
                        if (!regContent) return;
                        
                        let stepContent = '';
                        if (registrationStep === 1) {
                            stepContent = step1Template;
                        } else if (registrationStep === 2) {
                            stepContent = step2Template;
                        } else if (registrationStep === 3) {
                            stepContent = step3Template;
                        } else if (registrationStep === 4) {
                            stepContent = step4Template;
                        } else if (registrationStep === 5) {
                            stepContent = step5Template;
                            // パスワード入力フィールドを再描画後にリセット
                            setTimeout(() => {
                                for (let i = 0; i < 6; i++) {
                                    const input = document.getElementById(`pw-digit-${i}`);
                                    if (input) input.value = '';
                                }
                                checkPasswordCompletion(); // 初期状態でボタンを無効化
                            }, 100);
                        }
                        regContent.innerHTML = stepContent;
                        
                        // 描画後の値の反映
                        if (registrationStep === 1) {
                            if (document.getElementById('phone-number')) document.getElementById('phone-number').value = userData.phoneNumber;
                            if (document.getElementById('code-input-section') && !document.getElementById('code-input-section').classList.contains('hidden')) {
                                document.getElementById('auth-code').value = userData.authCode;
                            }
                        } else if (registrationStep === 2) {
                            if (document.getElementById('name')) document.getElementById('name').value = userData.name;
                            if (document.getElementById('age')) document.getElementById('age').value = userData.age;
                            if (document.getElementById('gender')) document.getElementById('gender').value = userData.gender;
                            if (document.getElementById('comment')) document.getElementById('comment').value = userData.comment;
                        } else if (registrationStep === 3) {
                            if (document.getElementById('email')) document.getElementById('email').value = userData.email;
                        }
                    }, 50);
                    break;
                case 'login':
                    content = loginTemplate;
                    // ログインフォームの値を反映
                    setTimeout(() => {
                        if (document.getElementById('login-id')) document.getElementById('login-id').value = userData.tempLoginId;
                        if (document.getElementById('login-pw')) document.getElementById('login-pw').value = userData.tempLoginPw;
                    }, 50);
                    break;
                default:
                    content = homeTemplate;
            }

            appElement.innerHTML = content;
        }

        // 初期ロード時に描画を開始
        window.onload = () => {
            render();
        };

    </script>
</body>
</html>
